<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PuzzleRef Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #0088cc;
            --primary-light: #e6f4ff;
            --secondary: #34b7f1;
            --accent: #6c5ce7;
            --text: #2d3436;
            --text-light: #636e72;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --border: #dfe6e9;
            --radius: 16px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding: 16px;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 16px;
        }

        .card-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            text-align: center;
        }

        .card-body {
            padding: 20px;
        }

        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.2);
            margin: 0 auto 12px;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        h1 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .username {
            display: inline-block;
            margin-bottom: 16px;
            color: rgba(255,255,255,0.9);
            font-weight: 500;
            text-decoration: none;
        }

        .description {
            color: rgba(255,255,255,0.8);
            font-size: 14px;
            margin-bottom: 0;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: 500;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 136, 204, 0.4);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            margin-top: 12px;
        }

        .btn-outline:hover {
            background: var(--primary-light);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
            outline: none;
        }

        .result {
            margin-top: 20px;
            animation: fadeIn 0.3s ease;
        }

        .result-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: #f8f9fa;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 16px;
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--primary-light);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-light);
        }

        .history-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .history-item-title {
            font-weight: 500;
            color: var(--text);
        }

        .history-item-date {
            font-size: 12px;
            color: var(--text-light);
        }

        .history-item-link {
            font-size: 13px;
            color: var(--primary);
            word-break: break-all;
            margin-bottom: 8px;
            display: block;
        }

        .history-item-stats {
            font-size: 12px;
            color: var(--text-light);
        }

        .click-details {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--border);
        }

        .click-detail {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 6px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .click-detail:last-child {
            border-bottom: none;
        }

        .click-detail-label {
            color: var(--text-light);
        }

        .click-detail-value {
            font-weight: 500;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 183, 241, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(52, 183, 241, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 183, 241, 0); }
        }

        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            vertical-align: middle;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            animation: slideUp 0.3s ease;
            display: none;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .qr-code {
            width: 160px;
            height: 160px;
            margin: 0 auto 16px;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }

        .qr-code img {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="toast" id="toast"></div>

        <!-- –ì–ª–∞–≤–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ -->
        <div class="card" id="mainCard">
            <div class="card-header">
                <div class="avatar">
                    <img id="avatarImage" src="https://pbt.storage.yandexcloud.net/cp_avatars/AgACAgIAAxUAAWf-xKkXxvc7CxsIzRj6wWh-XE6XAAJn-jEbzNyZS8T7Ny2Bcmv1AQADAgADYQADNgQ.jpg" alt="Avatar">
                </div>
                <h1 id="pageTitle">PuzzleRef Pro</h1>
                <a id="usernameLink" href="https://t.me/PuzzlerefBot" class="username">@PuzzlerefBot</a>
                <p id="pageDescription" class="description">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è Mini Apps</p>
            </div>
            
            <div class="card-body">
                <!-- –†–µ–∂–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                <div id="refMode">
                    <button id="tgButton" class="btn btn-primary pulse">–û—Ç–∫—Ä—ã—Ç—å –≤ Telegram</button>
                    <button id="showStatsBtn" class="btn btn-outline">–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
                </div>
                
                <!-- –†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å—Å—ã–ª–æ–∫ -->
                <div id="generatorMode" style="display: none;">
                    <div class="tabs">
                        <div class="tab active" data-tab="generator">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</div>
                        <div class="tab" data-tab="history">–ò—Å—Ç–æ—Ä–∏—è</div>
                        <div class="tab" data-tab="stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ -->
                    <div class="tab-content active" id="generatorTab">
                        <div class="form-group">
                            <label for="miniAppUrl">–°—Å—ã–ª–∫–∞ –Ω–∞ Mini App</label>
                            <input type="text" id="miniAppUrl" class="form-control" placeholder="https://t.me/your_mini_app">
                        </div>
                        <div class="form-group">
                            <label for="refParam">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä</label>
                            <input type="text" id="refParam" class="form-control" placeholder="ref12345">
                        </div>
                        <div class="form-group">
                            <label for="linkTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <input type="text" id="linkTitle" class="form-control" placeholder="–ú–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞">
                        </div>
                        <button id="generateBtn" class="btn btn-primary">
                            –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É
                            <span id="generateLoader" class="loader" style="display: none;"></span>
                        </button>
                        
                        <div id="result" class="result">
                            <input type="text" id="refLink" class="result-input" readonly>
                            <button id="copyBtn" class="btn btn-primary">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                            <button id="shareBtn" class="btn btn-outline">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
                            
                            <div id="qrCode" class="qr-code" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
                    <div class="tab-content" id="historyTab">
                        <div id="historyList"></div>
                    </div>
                    
                    <!-- –í–∫–ª–∞–¥–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
                    <div class="tab-content" id="statsTab">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalLinks">0</div>
                                <div class="stat-label">–í—Å–µ–≥–æ —Å—Å—ã–ª–æ–∫</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalClicks">0</div>
                                <div class="stat-label">–í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</label>
                            <div id="chart" style="height: 200px; background: #f5f6fa; border-radius: 12px; display: flex; align-items: flex-end; padding: 8px;">
                                <div style="flex: 1; display: flex; justify-content: center; align-items: flex-end;">
                                    <div style="width: 80%; background: var(--primary); height: 10%;" title="Day 1: 2 clicks"></div>
                                </div>
                                <!-- –ì—Ä–∞—Ñ–∏–∫ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                            <div id="devicesChart" style="height: 24px; background: #f5f6fa; border-radius: 12px; overflow: hidden; margin-bottom: 8px;">
                                <div style="width: 70%; height: 100%; background: var(--primary); display: inline-block;" title="Mobile: 70%"></div>
                                <div style="width: 30%; height: 100%; background: var(--secondary); display: inline-block;" title="Desktop: 30%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <div class="card" id="statsCard" style="display: none;">
            <div class="card-header">
                <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—Å—ã–ª–∫–∏</h1>
            </div>
            <div class="card-body">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="refClicks">0</div>
                        <div class="stat-label">–ü–µ—Ä–µ—Ö–æ–¥–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="refConversion">0%</div>
                        <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                    </div>
                </div>
                
                <div id="refHistoryList"></div>
                
                <button id="backToMainBtn" class="btn btn-outline">–ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>

    <script>
        // Telegram Bot Token
        const BOT_TOKEN = '7030085123:AAGxRwbTC-Kwr4TBpFxuhymfdDXKMzhIn6E';
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
        const urlParams = new URLSearchParams(window.location.search);
        const redirectUrl = urlParams.get('r');
        const refCode = urlParams.get('p');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram?.WebApp) {
            Telegram.WebApp.expand();
            Telegram.WebApp.enableClosingConfirmation();
            Telegram.WebApp.setHeaderColor('#0088cc');
            Telegram.WebApp.setBackgroundColor('#f8f9fa');
        }
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const mainCard = document.getElementById('mainCard');
        const statsCard = document.getElementById('statsCard');
        const refMode = document.getElementById('refMode');
        const generatorMode = document.getElementById('generatorMode');
        const toast = document.getElementById('toast');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showToast(message, duration = 3000) {
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            if (redirectUrl) {
                // –†–µ–∂–∏–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                generatorMode.style.display = 'none';
                
                // –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
                customizeFromUrl();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏
                setupRefButton();
                
                // –¢—Ä–µ–∫–∏–Ω–≥ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
                if (refCode) {
                    trackReferral(refCode);
                }
            } else {
                // –†–µ–∂–∏–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å—Å—ã–ª–æ–∫
                refMode.style.display = 'none';
                generatorMode.style.display = 'block';
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫
                initTabs();
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å—Å—ã–ª–æ–∫
                initLinkGenerator();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
                loadHistory();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            document.getElementById('showStatsBtn')?.addEventListener('click', showStats);
            document.getElementById('backToMainBtn')?.addEventListener('click', () => {
                statsCard.style.display = 'none';
                mainCard.style.display = 'block';
            });
        }
        
        // –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ URL
        function customizeFromUrl() {
            const title = urlParams.get('title');
            const description = urlParams.get('description');
            const imageUrl = urlParams.get('image');
            const username = urlParams.get('username');
            
            if (title) document.getElementById('pageTitle').textContent = decodeURIComponent(title);
            if (description) document.getElementById('pageDescription').textContent = decodeURIComponent(description);
            if (imageUrl) document.getElementById('avatarImage').src = decodeURIComponent(imageUrl);
            if (username) {
                const usernameLink = document.getElementById('usernameLink');
                usernameLink.textContent = `@${decodeURIComponent(username)}`;
                usernameLink.href = `https://t.me/${decodeURIComponent(username)}`;
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        function setupRefButton() {
            document.getElementById('tgButton').addEventListener('click', () => {
                if (window.Telegram?.WebApp) {
                    Telegram.WebApp.openTelegramLink(redirectUrl);
                } else {
                    window.location.href = redirectUrl;
                }
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∫–ª–∞–¥–æ–∫
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
                    tabs.forEach(t => t.classList.remove('active'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
                    tab.classList.add('active');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –≤–∫–ª–∞–¥–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
                    if (tabId === 'history') {
                        displayHistory();
                    }
                });
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å—Å—ã–ª–æ–∫
        function initLinkGenerator() {
            document.getElementById('generateBtn').addEventListener('click', generateReferralLink);
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('shareBtn').addEventListener('click', shareLink);
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
        function generateReferralLink() {
            const miniAppUrl = document.getElementById('miniAppUrl').value.trim();
            const refParam = document.getElementById('refParam').value.trim();
            const linkTitle = document.getElementById('linkTitle').value.trim();
            
            if (!miniAppUrl) {
                showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ Mini App');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º loader
            const generateBtn = document.getElementById('generateBtn');
            const loader = document.getElementById('generateLoader');
            generateBtn.disabled = true;
            loader.style.display = 'inline-block';
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É
            let refLink = `${window.location.origin}${window.location.pathname}?r=${encodeURIComponent(miniAppUrl)}`;
            
            if (refParam) {
                refLink += `&p=${encodeURIComponent(refParam)}`;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
            if (tgUser) {
                if (tgUser.username) refLink += `&username=${encodeURIComponent(tgUser.username)}`;
                if (tgUser.first_name) refLink += `&title=${encodeURIComponent(tgUser.first_name)}`;
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            if (linkTitle) {
                refLink += `&link_title=${encodeURIComponent(linkTitle)}`;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            setTimeout(() => {
                document.getElementById('refLink').value = refLink;
                document.getElementById('result').style.display = 'block';
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR-–∫–æ–¥
                generateQRCode(refLink);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
                addToHistory({
                    miniAppUrl,
                    refParam,
                    generatedLink: refLink,
                    title: linkTitle || `–°—Å—ã–ª–∫–∞ ${new Date().toLocaleDateString()}`
                });
                
                // –°–∫—Ä—ã–≤–∞–µ–º loader
                generateBtn.disabled = false;
                loader.style.display = 'none';
                
                showToast('–°—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
            }, 500);
        }
        
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞
        function generateQRCode(url) {
            const qrCodeContainer = document.getElementById('qrCode');
            qrCodeContainer.innerHTML = '';
            qrCodeContainer.style.display = 'block';
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–∞
            // –ù–∞–ø—Ä–∏–º–µ—Ä: new QRCode(qrCodeContainer, url);
            
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            const canvas = document.createElement('canvas');
            canvas.width = 160;
            canvas.height = 160;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 160, 160);
            ctx.fillStyle = '#000000';
            ctx.font = '14px Arial';
            ctx.fillText('QR Code', 50, 80);
            qrCodeContainer.appendChild(canvas);
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
        function copyToClipboard() {
            const refLinkInput = document.getElementById('refLink');
            refLinkInput.select();
            document.execCommand('copy');
            
            showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }
        
        // –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π
        function shareLink() {
            const refLink = document.getElementById('refLink').value;
            
            if (navigator.share) {
                navigator.share({
                    title: '–ú–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞',
                    text: '–ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ –º–æ–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ:',
                    url: refLink
                }).catch(console.error);
            } else if (window.Telegram?.WebApp) {
                Telegram.WebApp.showAlert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –µ—é –≤—Ä—É—á–Ω—É—é: ' + refLink);
            } else {
                showToast('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –µ—é –≤—Ä—É—á–Ω—É—é');
            }
        }
        
        // –†–∞–±–æ—Ç–∞ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        function addToHistory(linkData) {
            const history = getHistory();
            const ownerChatId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è —Å—Å—ã–ª–∫–∞
            const existingLink = history.find(item => 
                item.generatedLink === linkData.generatedLink && 
                item.ownerChatId === ownerChatId
            );
            
            if (!existingLink) {
                history.unshift({
                    ...linkData,
                    createdAt: new Date().toISOString(),
                    clicks: 0,
                    clickDetails: [],
                    ownerChatId: ownerChatId
                });
                saveHistory(history);
            }
            
            displayHistory();
            updateStats();
        }
        
        function getHistory() {
            return JSON.parse(localStorage.getItem('linkHistory') || '[]');
        }
        
        function saveHistory(history) {
            localStorage.setItem('linkHistory', JSON.stringify(history));
        }
        
        function loadHistory() {
            displayHistory();
            updateStats();
        }
        
        function displayHistory() {
            const historyList = document.getElementById('historyList');
            const history = getHistory();
            const currentUserChatId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userHistory = history.filter(item => item.ownerChatId === currentUserChatId);
            
            if (userHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-light);">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</p>';
                return;
            }
            
            historyList.innerHTML = userHistory.map(item => `
                <div class="history-item">
                    <div class="history-item-header">
                        <div class="history-item-title">${item.title || '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞'}</div>
                        <div class="history-item-date">${new Date(item.createdAt).toLocaleDateString()}</div>
                    </div>
                    <a href="${item.generatedLink}" target="_blank" class="history-item-link">${item.generatedLink}</a>
                    <div class="history-item-stats">
                        –ü–µ—Ä–µ—Ö–æ–¥–æ–≤: ${item.clicks}
                        ${item.clickDetails && item.clickDetails.length > 0 ? `
                        <div class="click-details">
                            ${item.clickDetails.slice(0, 3).map(click => `
                                <div class="click-detail">
                                    <span class="click-detail-label">${new Date(click.timestamp).toLocaleString()}</span>
                                    <span class="click-detail-value">${click.device === 'mobile' ? 'üì±' : 'üíª'} ${click.username ? '@' + click.username : '–ê–Ω–æ–Ω–∏–º'}</span>
                                </div>
                            `).join('')}
                            ${item.clickDetails.length > 3 ? `<div style="text-align: center; font-size: 11px; color: var(--primary);">+${item.clickDetails.length - 3} –µ—â–µ</div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function updateStats() {
            const history = getHistory();
            const currentUserChatId = window.Telegram?.WebApp?.initDataUnsafe?.user?.id;
            const userHistory = history.filter(item => item.ownerChatId === currentUserChatId);
            
            // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Å—ã–ª–æ–∫
            document.getElementById('totalLinks').textContent = userHistory.length;
            
            // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
            const totalClicks = userHistory.reduce((sum, item) => sum + (item.clicks || 0), 0);
            document.getElementById('totalClicks').textContent = totalClicks;
            
            // TODO: –û–±–Ω–æ–≤–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        }
        
        // –¢—Ä–µ–∫–∏–Ω–≥ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
        function trackReferral(refCode) {
            const currentUrl = window.location.href;
            const clickDetail = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                device: /Mobile|Android|iPhone/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                browser: getBrowserName(),
                username: window.Telegram?.WebApp?.initDataUnsafe?.user?.username,
                ip: '' // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π API
            };
            
            // –ò—â–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Å—ã–ª–∫—É –≤ –∏—Å—Ç–æ—Ä–∏–∏
            const history = getHistory();
            const historyItem = history.find(item => {
                try {
                    const itemUrl = new URL(item.generatedLink);
                    const currentUrlObj = new URL(currentUrl);
                    
                    return (
                        itemUrl.searchParams.get('r') === currentUrlObj.searchParams.get('r') &&
                        itemUrl.searchParams.get('p') === currentUrlObj.searchParams.get('p')
                    );
                } catch (e) {
                    return false;
                }
            });
            
            if (historyItem) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                historyItem.clicks = (historyItem.clicks || 0) + 1;
                if (!historyItem.clickDetails) historyItem.clickDetails = [];
                historyItem.clickDetails.push(clickDetail);
                saveHistory(history);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å–æ–∑–¥–∞—Ç–µ–ª—é —Å—Å—ã–ª–∫–∏
                sendTelegramNotification(historyItem, clickDetail);
                
                // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥
                console.log('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', {
                    referralCode: refCode,
                    link: historyItem.generatedLink,
                    details: clickDetail
                });
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        function sendTelegramNotification(historyItem, clickDetail) {
            if (!historyItem.ownerChatId) return;
            
            const username = clickDetail.username ? `@${clickDetail.username}` : '–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            const device = clickDetail.device === 'mobile' ? '–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ' : '–ö–æ–º–ø—å—é—Ç–µ—Ä';
            const browser = clickDetail.browser;
            
            const message = `üîî *–ù–æ–≤—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ!*\n\n` +
                           `üìå *–°—Å—ã–ª–∫–∞:* ${historyItem.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}\n` +
                           `üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* ${username}\n` +
                           `üì± *–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:* ${device}\n` +
                           `üåê *–ë—Ä–∞—É–∑–µ—Ä:* ${browser}\n` +
                           `üïí *–í—Ä–µ–º—è:* ${new Date(clickDetail.timestamp).toLocaleString()}\n\n` +
                           `–í—Å–µ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: ${historyItem.clicks}`;
            
            fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: historyItem.ownerChatId,
                    text: message,
                    parse_mode: 'Markdown'
                })
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function showStats() {
            const currentUrl = window.location.href;
            const history = getHistory();
            const historyItem = history.find(item => item.generatedLink.includes(currentUrl));
            
            if (historyItem) {
                document.getElementById('refClicks').textContent = historyItem.clicks || 0;
                document.getElementById('refConversion').textContent = '0%'; // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –º–æ–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
                const refHistoryList = document.getElementById('refHistoryList');
                if (historyItem.clickDetails && historyItem.clickDetails.length > 0) {
                    refHistoryList.innerHTML = `
                        <h3 style="margin-bottom: 12px; font-size: 16px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã</h3>
                        ${historyItem.clickDetails.map(click => `
                            <div class="click-detail">
                                <span class="click-detail-label">${new Date(click.timestamp).toLocaleString()}</span>
                                <span class="click-detail-value">${click.device === 'mobile' ? 'üì±' : 'üíª'} ${click.username ? '@' + click.username : '–ê–Ω–æ–Ω–∏–º'}</span>
                            </div>
                        `).join('')}
                    `;
                } else {
                    refHistoryList.innerHTML = '<p style="text-align: center; color: var(--text-light);">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö</p>';
                }
                
                mainCard.style.display = 'none';
                statsCard.style.display = 'block';
            } else {
                showToast('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è —ç—Ç–æ–π —Å—Å—ã–ª–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞
        function getBrowserName() {
            const userAgent = navigator.userAgent;
            if (userAgent.indexOf("Firefox") > -1) return "Firefox";
            if (userAgent.indexOf("SamsungBrowser") > -1) return "Samsung Browser";
            if (userAgent.indexOf("Opera") > -1 || userAgent.indexOf("OPR") > -1) return "Opera";
            if (userAgent.indexOf("Trident") > -1) return "Internet Explorer";
            if (userAgent.indexOf("Edge") > -1) return "Edge";
            if (userAgent.indexOf("Chrome") > -1) return "Chrome";
            if (userAgent.indexOf("Safari") > -1) return "Safari";
            return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä";
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
