<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Конструктор HTML блоков</title>
  <style>
    /* Общие стили */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #f2f2f2;
      color: #333;
    }
    .header {
      background-color: #0088cc;
      color: #fff;
      padding: 15px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header button {
      background-color: #ff3b30;
      border: none;
      color: #fff;
      padding: 7px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    .container {
      display: flex;
      padding: 20px;
      gap: 20px;
    }
    .sidebar, .content {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px;
      overflow-y: auto;
      max-height: 80vh;
    }
    .sidebar {
      width: 320px;
    }
    h3 {
      margin-bottom: 10px;
      font-size: 16px;
    }
    .block {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 10px;
      background-color: #fafafa;
      position: relative;
    }
    .block p {
      margin-top: 5px;
      word-break: break-all;
    }
    .block-actions {
      margin-top: 8px;
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .block-actions button {
      background-color: #0088cc;
      border: none;
      color: #fff;
      padding: 5px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    .form-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      font-size: 14px;
    }
    input[type="text"], textarea, input[type="color"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
    }
    button.primary {
      background-color: #0088cc;
      border: none;
      color: #fff;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 5px;
    }
    button.primary:hover {
      background-color: #0077b3;
    }
    button.secondary {
      background-color: #aaa;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 5px;
    }
    hr {
      margin: 15px 0;
      border: none;
      border-top: 1px solid #eee;
    }
    .variable-item {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .variable-item input[type="text"] {
      flex: 1;
    }
    .demo-code {
      background-color: #272c34;
      color: #fff;
      padding: 10px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 300px;
    }
    .export-btn {
      background-color: #4cd964;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="header">
    <span>Телеграм мини-приложение: Конструктор HTML блоков</span>
    <button onclick="clearAll()">Очистить все</button>
  </div>
  
  <div class="container">
    <!-- Левая панель: блоки, форма добавления/редактирования, переменные -->
    <div class="sidebar">
      <h3>Список блоков</h3>
      <div id="blocks-list">
        <!-- Здесь будут отображаться блоки -->
      </div>
      
      <hr>
      
      <h3 id="form-title">Добавить блок</h3>
      <div id="add-block-form">
        <div class="form-group">
          <label for="block-title">Заголовок блока</label>
          <input type="text" id="block-title" placeholder="Введите название блока">
        </div>
        <div class="form-group">
          <label for="block-content">Содержимое (HTML)</label>
          <textarea id="block-content" rows="4" placeholder="Например: Привет, {{username}}!"></textarea>
        </div>
        <div class="form-group">
          <label for="block-bgcolor">Цвет фона</label>
          <input type="color" id="block-bgcolor" value="#fafafa">
        </div>
        <div class="form-group">
          <label for="block-textcolor">Цвет текста</label>
          <input type="color" id="block-textcolor" value="#333333">
        </div>
        <button class="primary" id="save-block-btn" onclick="saveBlock()">Добавить блок</button>
        <button class="secondary" id="cancel-edit-btn" onclick="cancelEdit()" style="display:none;">Отмена</button>
      </div>
      
      <hr>
      
      <h3>Переменные</h3>
      <div id="variables">
        <!-- Список переменных -->
      </div>
      <button class="primary" onclick="addVariable()">Добавить переменную</button>
    </div>
    
    <!-- Правая панель: превью и демонстрация HTML кода -->
    <div class="content">
      <h3>Превью</h3>
      <div id="preview">
        <!-- Динамически отображаются блоки с подстановкой переменных -->
      </div>
      
      <hr>
      
      <h3>HTML код с демо данными</h3>
      <pre class="demo-code" id="demo-code">
        <!-- Сюда выводится HTML код блоков -->
      </pre>
      <button class="export-btn" onclick="exportCode()">Скопировать код</button>
    </div>
  </div>
  
  <script>
    // Глобальные переменные
    let blocks = [];
    let variables = {};
    let currentEditIndex = -1; // -1 означает режим добавления

    // Загрузка данных из localStorage или установка демо значений
    function loadData() {
      const savedBlocks = localStorage.getItem('blocks');
      const savedVariables = localStorage.getItem('variables');
      if (savedBlocks) {
        blocks = JSON.parse(savedBlocks);
      } else {
        blocks = [{
          title: "Блок 1",
          content: "Привет, {{username}}! Добро пожаловать в наше мини-приложение.",
          style: { bgcolor: "#fafafa", textcolor: "#333333" }
        }];
      }
      if (savedVariables) {
        variables = JSON.parse(savedVariables);
      } else {
        variables = { username: "Иван" };
      }
    }

    // Сохранение данных в localStorage
    function saveData() {
      localStorage.setItem('blocks', JSON.stringify(blocks));
      localStorage.setItem('variables', JSON.stringify(variables));
    }

    // Отрисовка блоков в превью с подстановкой переменных и стилями
    function renderBlocks() {
      const preview = document.getElementById('preview');
      preview.innerHTML = "";
      blocks.forEach(block => {
        let renderedContent = block.content;
        for (let key in variables) {
          const regex = new RegExp("{{\\s*" + key + "\\s*}}", "g");
          renderedContent = renderedContent.replace(regex, variables[key]);
        }
        const blockEl = document.createElement("div");
        blockEl.className = "block";
        blockEl.style.backgroundColor = block.style.bgcolor;
        blockEl.style.color = block.style.textcolor;
        blockEl.innerHTML = "<strong>" + block.title + "</strong><br>" + renderedContent;
        preview.appendChild(blockEl);
      });
      updateDemoCode();
    }

    // Отрисовка списка блоков в левой панели
    function renderSidebarBlocks() {
      const blocksList = document.getElementById('blocks-list');
      blocksList.innerHTML = "";
      blocks.forEach((block, index) => {
        const div = document.createElement("div");
        div.className = "block";
        div.setAttribute("data-index", index);
        div.style.backgroundColor = block.style.bgcolor;
        div.style.color = block.style.textcolor;
        div.innerHTML = "<strong>" + block.title + "</strong><p>" + block.content + "</p>";
        // Панель действий для блока
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "block-actions";
        actionsDiv.innerHTML = `
          <button onclick="editBlock(${index})">Редактировать</button>
          <button onclick="deleteBlock(${index})">Удалить</button>
          <button onclick="moveBlockUp(${index})">↑</button>
          <button onclick="moveBlockDown(${index})">↓</button>
        `;
        div.appendChild(actionsDiv);
        blocksList.appendChild(div);
      });
    }

    // Обновление области с демонстрационным HTML кодом
    function updateDemoCode() {
      const demoCode = document.getElementById('demo-code');
      let codeStr = "";
      blocks.forEach(block => {
        codeStr += `<div class="block-demo" style="background: ${block.style.bgcolor}; color: ${block.style.textcolor};">\n`;
        codeStr += `  <h3>${block.title}</h3>\n`;
        codeStr += `  <p>${block.content}</p>\n`;
        codeStr += `</div>\n\n`;
      });
      demoCode.textContent = codeStr;
    }

    // Добавление или сохранение блока (в зависимости от режима)
    function saveBlock() {
      const title = document.getElementById('block-title').value.trim();
      const content = document.getElementById('block-content').value.trim();
      const bgcolor = document.getElementById('block-bgcolor').value;
      const textcolor = document.getElementById('block-textcolor').value;
      
      if (!title || !content) {
        alert("Пожалуйста, заполните заголовок и содержимое блока.");
        return;
      }
      
      const blockData = {
        title: title,
        content: content,
        style: { bgcolor: bgcolor, textcolor: textcolor }
      };
      
      if (currentEditIndex === -1) {
        // Режим добавления
        blocks.push(blockData);
      } else {
        // Режим редактирования
        blocks[currentEditIndex] = blockData;
        currentEditIndex = -1;
        document.getElementById('form-title').textContent = "Добавить блок";
        document.getElementById('save-block-btn').textContent = "Добавить блок";
        document.getElementById('cancel-edit-btn').style.display = "none";
      }
      
      clearBlockForm();
      renderSidebarBlocks();
      renderBlocks();
      saveData();
    }

    // Заполнение формы редактирования блока
    function editBlock(index) {
      currentEditIndex = index;
      const block = blocks[index];
      document.getElementById('block-title').value = block.title;
      document.getElementById('block-content').value = block.content;
      document.getElementById('block-bgcolor').value = block.style.bgcolor;
      document.getElementById('block-textcolor').value = block.style.textcolor;
      document.getElementById('form-title').textContent = "Редактировать блок";
      document.getElementById('save-block-btn').textContent = "Сохранить изменения";
      document.getElementById('cancel-edit-btn').style.display = "inline-block";
    }

    // Отмена редактирования блока
    function cancelEdit() {
      currentEditIndex = -1;
      clearBlockForm();
      document.getElementById('form-title').textContent = "Добавить блок";
      document.getElementById('save-block-btn').textContent = "Добавить блок";
      document.getElementById('cancel-edit-btn').style.display = "none";
    }

    // Очистка формы блока
    function clearBlockForm() {
      document.getElementById('block-title').value = "";
      document.getElementById('block-content').value = "";
      document.getElementById('block-bgcolor').value = "#fafafa";
      document.getElementById('block-textcolor').value = "#333333";
    }

    // Удаление блока
    function deleteBlock(index) {
      if (confirm("Удалить этот блок?")) {
        blocks.splice(index, 1);
        renderSidebarBlocks();
        renderBlocks();
        saveData();
      }
    }

    // Перемещение блока вверх
    function moveBlockUp(index) {
      if (index > 0) {
        [blocks[index - 1], blocks[index]] = [blocks[index], blocks[index - 1]];
        renderSidebarBlocks();
        renderBlocks();
        saveData();
      }
    }

    // Перемещение блока вниз
    function moveBlockDown(index) {
      if (index < blocks.length - 1) {
        [blocks[index + 1], blocks[index]] = [blocks[index], blocks[index + 1]];
        renderSidebarBlocks();
        renderBlocks();
        saveData();
      }
    }

    // Отрисовка списка переменных
    function renderVariables() {
      const variablesDiv = document.getElementById('variables');
      variablesDiv.innerHTML = "";
      for (let key in variables) {
        const varItem = document.createElement('div');
        varItem.className = 'variable-item';
        varItem.innerHTML = `<label for="var-${key}">${key}:</label>
                             <input type="text" id="var-${key}" value="${variables[key]}" oninput="updateVariable('${key}')">
                             <button class="secondary" onclick="deleteVariable('${key}')">Удалить</button>`;
        variablesDiv.appendChild(varItem);
      }
    }

    // Обновление значения переменной
    function updateVariable(varName) {
      variables[varName] = document.getElementById('var-' + varName).value;
      renderBlocks();
      updateDemoCode();
      saveData();
    }

    // Добавление новой переменной
    function addVariable() {
      const varName = prompt("Введите имя переменной (без фигурных скобок):");
      if (varName) {
        if (variables.hasOwnProperty(varName)) {
          alert("Переменная с таким именем уже существует.");
          return;
        }
        const varValue = prompt("Введите значение для переменной " + varName + ":");
        if (varValue !== null) {
          variables[varName] = varValue;
          renderVariables();
          renderBlocks();
          saveData();
        }
      }
    }

    // Удаление переменной
    function deleteVariable(varName) {
      if (confirm("Удалить переменную " + varName + "?")) {
        delete variables[varName];
        renderVariables();
        renderBlocks();
        saveData();
      }
    }

    // Экспорт кода: копирование содержимого HTML кода в буфер обмена
    function exportCode() {
      const code = document.getElementById('demo-code').textContent;
      navigator.clipboard.writeText(code)
        .then(() => alert("Код скопирован в буфер обмена!"))
        .catch(() => alert("Не удалось скопировать код."));
    }

    // Очистить все данные и сбросить настройки
    function clearAll() {
      if (confirm("Вы уверены, что хотите очистить все данные?")) {
        localStorage.clear();
        blocks = [{
          title: "Блок 1",
          content: "Привет, {{username}}! Добро пожаловать в наше мини-приложение.",
          style: { bgcolor: "#fafafa", textcolor: "#333333" }
        }];
        variables = { username: "Иван" };
        currentEditIndex = -1;
        clearBlockForm();
        renderSidebarBlocks();
        renderBlocks();
        renderVariables();
      }
    }

    // Инициализация приложения
    function init() {
      loadData();
      renderSidebarBlocks();
      renderBlocks();
      renderVariables();
    }
    
    init();
  </script>
</body>
</html>
